name: Daily Sync with Upstream

# 每天自动触发，也可以手动触发
on:
  schedule:
    - cron: '0 3 * * *'  # 每天 UTC 03:00（北京时间 11:00）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出你的 fork 仓库
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # 必须获取完整历史，以便 merge

      # 2. 添加原仓库为 upstream
      - name: Add upstream remote
        run: git remote add upstream https://github.com/maillab/cloud-mail.git

      # 3. 获取 upstream main 的最新提交
      - name: Fetch upstream
        run: git fetch upstream main

      # 4. 合并 upstream main 到你的 fork main
      - name: Merge upstream/main
        run: |
          git checkout main
          git merge upstream/main --allow-unrelated-histories -m "Daily sync from upstream"

      # 5. 推送回你的 fork
      - name: Push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
